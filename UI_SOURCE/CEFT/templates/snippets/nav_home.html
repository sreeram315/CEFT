{% load static %}
<nav class="navbar navbar-expand-lg navbar navbar-dark bg-dark">

  <a class="navbar-brand" href="/">WIRA</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item {% if request.get_full_path == '/' %}active{% endif %}">
        <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
      </li>

      <li class="nav-item {% if 'contact' in request.get_full_path %} active {% endif %}">
        <a class="nav-link" href="/contact">Contact us</a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="/admin" tabindex="-1" aria-disabled="true">Admin Login</a>
      </li>
    </ul>
  </div>
</nav>



<div class="pt-2 pl-5 pr-5">
<div class="alert alert-success" id="otp_verification_successful" role="alert">
  OTP verification succesfull. Thank you.
</div>
</div>

{% if user.is_authenticated and not user.userprofile.is_verified %}

<div class="pt-2 pl-5 pr-5" id="verify_warning">
<div class="alert alert-warning" role="alert">
  Your contact number (+91 {{user.userprofile.contact_number}}) is not verified, please do so to avoid inactivation.

  <span><button type="button" class="btn btn-warning" id="send_otp_btn" data-toggle="modal" data-target="#OTPModal">Send OTP</button></span>


<!-- Modal -->
<div class="modal fade" id="OTPModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        An OTP has been sent to {{user.userprofile.contact_number}}. Please enter it below to verify.
              <div class="otp_field pt-2">
                <input type="text" name="otp" id="otp_field" class="form-control" id="exampleDropdownFormEmail1" placeholder="OTP here">
              </div>
      </div>
      <div class="modal-footer">
        <button id="resend_otp_btn" type="button" class="btn btn-secondary">Resend OTP</button>
        <button id="close_model_btn" type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button id="submit_otp_btn" type="button" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>
</div>



</div>
</div>

<input hidden id="username" type="text" name="username" value="{{user.username}}">

{% endif %}



<script
  src="https://code.jquery.com/jquery-3.4.1.js"
  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
  crossorigin="anonymous"></script>



<script type="text/javascript">

window.CSRF_TOKEN = "{{ csrf_token }}";
$("#otp_verification_successful").hide();
function loginFunc() {
  console.log("Submititng form ")
  document.getElementById("loginForm").submit();
}

  var username = $("#username").val();
  console.log(username);


function send_otp(username){
      data = {
        "username": username,
        csrfmiddlewaretoken: window.CSRF_TOKEN
      }
      $.ajax({ 
          type: "post", 
          url: "/accounts/api/send-otp/",
          enctype: "multipart/form-data",
          data: data,
          success: function(e) {
            console.log('SUCCESS', e.responseText);
          },
          error: function(e) {
            console.log('FAILED', e.responseText);
          } 
        });
}

$(function(){
    console.log("YELP")

    $("#otp_verification_successful").hide();

    $("#send_otp_btn").click(function(){
      console.log("sending otp");
      username = username;
      send_otp(username);
    })

    $("#submit_otp_btn").click(function(){
      $("#submit_otp_btn").addClass('disabled');
      console.log("verifying otp");
      console.log( $('#otp_field').val())
      data = {
                "username": username,
                "otp": $('#otp_field').val(),
                csrfmiddlewaretoken: window.CSRF_TOKEN
            }
      $.ajax({ 
          type: "post", 
          url: "/accounts/api/verify/",
          enctype: "multipart/form-data",
          data: data,
          success: function(e) {
            console.log('SUCCESS', e.responseText);
            $("#otp_verification_successful").show();
            $("#close_model_btn").click();
            $("#verify_warning").hide();
          },
          error: function(e) {
            console.log('FAILED', e.responseText);
          } 
        });
    })


    $("#resend_otp_btn").click(function(){
      $("#resend_otp_btn").text("SENT");
       $("#resend_otp_btn").addClass("disabled");
      username = username;
      send_otp(username);
    })

    $("#edit_profile_btn").click(function(e){
      alert("Kindly contact site admin to edit your profile data.  Call +918919937557 or send an email to sreerammaram2@gmail.com")
    })

    $("#goto_register_btn").click(function(){
      window.location = '/register';
    })
})

</script>






